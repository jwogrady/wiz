#!/usr/bin/env bash
# ==============================================================================
# Wiz - Terminal Magic: Bootstrap Script (Phase 1)
# ==============================================================================
# This script is designed to be curl-piped from GitHub for initial setup.
# It clones the repo and runs Phase 1 (identity & SSH setup only).
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/jwogrady/wiz/main/bin/bootstrap | bash
#
# ==============================================================================

set -euo pipefail

# --- Source Common Utilities ---
WIZ_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck source=lib/common.sh
source "${WIZ_ROOT}/lib/common.sh"

# --- Banner (bootstrap-specific) ---
show_bootstrap_banner() {
    cat <<'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘   ğŸŒŒ  WIZ - TERMINAL MAGIC  âœ¨                            â•‘
â•‘                                                            â•‘
â•‘   Phase 1: Identity & SSH Setup                           â•‘
â•‘   https://github.com/jwogrady/wiz                          â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
}

# --- Check Requirements ---
check_requirements() {
    local missing=()
    
    for cmd in git curl; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        error "Missing required commands: ${missing[*]}"
    fi
}

# --- Import SSH Keys Early (for git clone) ---
# This is a minimal import - just extract keys and load into agent for git clone
# Full import with all checks happens in install Phase 1
import_ssh_keys_bootstrap() {
    local win_user="$1"
    local ssh_dir="${HOME}/.ssh"
    
    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir" 2>/dev/null || true
    
    # Check for C:\Users\{WIN_USER}\keys.tar.gz archive
    local keys_archive="/mnt/c/Users/${win_user}/keys.tar.gz"
    if [[ -f "$keys_archive" ]]; then
        log "Importing SSH keys from Windows for repository access..."
        
        # Extract keys using shared function
        if ! extract_ssh_keys_from_archive "$keys_archive" "$ssh_dir"; then
            return 1
        fi
        
        # Start ssh-agent and load keys
        if command -v ssh-agent >/dev/null 2>&1 && command -v ssh-add >/dev/null 2>&1; then
            eval "$(ssh-agent -s)" >/dev/null 2>&1 || true
            
            # Add all private keys to the agent
            local keys_loaded=0
            for key in "$ssh_dir"/*; do
                [[ -f "$key" ]] || continue
                [[ "$key" == *.pub ]] && continue
                [[ "$key" == *known_hosts* ]] && continue
                if ssh-add "$key" 2>/dev/null; then
                    ((keys_loaded++))
                fi
            done
            
            if [[ $keys_loaded -gt 0 ]]; then
                success "SSH keys imported and loaded ($keys_loaded key(s))"
            else
                success "SSH keys imported"
            fi
            return 0
        fi
        
        success "SSH keys imported"
        return 0
    fi
    
    return 1
}

# --- Main ---
main() {
    show_bootstrap_banner
    
    log "Starting Wiz bootstrap (Phase 1)..."
    echo ""
    
    # Check requirements
    check_requirements
    
    # Auto-detect Windows username for SSH key import
    local WIN_USER
    WIN_USER="$(detect_windows_user)" || WIN_USER=""
    
    # Import SSH keys early (needed for git clone if using SSH)
    local use_ssh=false
    if [[ -n "$WIN_USER" ]] && import_ssh_keys_bootstrap "$WIN_USER"; then
        use_ssh=true
        log "SSH keys available, using SSH for repository access"
    else
        log "Using HTTPS for repository access"
    fi
    
    # Define installation directory
    local WIZ_DIR="${HOME}/wiz"
    
    # Clone repository if not already present
    if [[ -d "$WIZ_DIR" ]]; then
        log "Wiz directory already exists at ${WIZ_DIR}"
        log "Updating existing repository..."
        cd "$WIZ_DIR"
        
        # If SSH keys are available, try to update remote URL to SSH
        if [[ "$use_ssh" == "true" ]]; then
            git remote set-url origin git@github.com:jwogrady/wiz.git 2>/dev/null || true
        fi
        
        git pull origin main 2>/dev/null || {
            warn "Could not update repository, using existing version"
        }
    fi
    
    if [[ ! -d "$WIZ_DIR" ]]; then
        log "Cloning Wiz repository..."
        
        # Try SSH first if keys are available, fallback to HTTPS
        if [[ "$use_ssh" == "true" ]]; then
            if git clone git@github.com:jwogrady/wiz.git "$WIZ_DIR" 2>/dev/null; then
                success "Repository cloned via SSH to ${WIZ_DIR}"
            else
                warn "SSH clone failed, trying HTTPS..."
                git clone https://github.com/jwogrady/wiz.git "$WIZ_DIR" || error "Failed to clone repository"
                success "Repository cloned via HTTPS to ${WIZ_DIR}"
            fi
        else
            git clone https://github.com/jwogrady/wiz.git "$WIZ_DIR" || error "Failed to clone repository"
            success "Repository cloned to ${WIZ_DIR}"
        fi
    fi
    
    echo ""
    log "Switching to ${WIZ_DIR}..."
    cd "$WIZ_DIR"
    
    # Make install script executable
    chmod +x bin/install
    
    # Run Phase 1 only (identity setup, skip modules)
    echo ""
    log "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log "Starting Phase 1: Identity & SSH Setup"
    log "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    ./bin/install --skip-modules "$@"
}

main "$@"
